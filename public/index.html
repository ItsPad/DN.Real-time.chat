<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Realtime Chat</title>
    <link rel="stylesheet" href="css/style.css" />
    <!-- เพิ่มบรรทัดนี้ -->
  </head>
  <body>
    <div class="chat-container">
      <header>
        <h2>REALTIME CHAT</h2>
        <div id="user-count" style="font-size: 0.9em; margin-top: 4px">
          Online: 0
        </div>
      </header>

      <ul id="messages"></ul>

      <div id="typing">User is typing...</div>
      <form action="" id="form">
        <input
          type="text"
          id="input"
          autocomplete="off"
          placeholder="Write some messages"
        />
        <button>Send</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const messages = document.getElementById("messages");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const userID = Date.now();
      const userCountDiv = document.getElementById("user-count");
      const typingDiv = document.getElementById("typing");
      typingDiv.style.display = "none"; // ซ่อนตอนเริ่มต้น

      let name = prompt("What is your desired username?");
      let typingUsers = new Set();

      // ส่งข้อความ
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit("username", name);
          socket.emit("chat message", {
            name: name,
            msg: input.value,
            user: userID,
          });
          input.value = "";
          socket.emit("stop typing", name); // ต้องส่ง name ไปด้วย
        }
      });

      // 📌 แจ้ง server ว่ากำลังพิมพ์
      input.addEventListener("input", () => {
        if (input.value.length > 0) {
          socket.emit("typing", name);
        } else {
          socket.emit("stop typing", name); // ต้องส่ง name ไปด้วย
        }
      });

      // 📌 รับข้อความจากคนอื่น
      socket.on("chat message", (msgObject) => {
        const message = document.createElement("li");
        const messageItem = document.createElement("span");
        messageItem.textContent = `${msgObject.name}: ${msgObject.msg}`;
        if (msgObject.user === userID) {
          message.classList.add("right");
        }
        message.appendChild(messageItem);
        messages.appendChild(message);
        messages.scrollTop = messages.scrollHeight; // auto scroll
      });

      // 📌 รับจำนวนคนออนไลน์
      socket.on("user count", (count) => {
        userCountDiv.textContent = `🟢Online: ${count}`;
      });

      // 📌 แสดงว่าใครกำลังพิมพ์
      socket.on("typing", (username) => {
        if (username !== name) {
          typingUsers.add(username);
          updateTypingDiv();
        }
      });

      // 📌 หยุดแสดง typing
      socket.on("stop typing", (username) => {
        typingUsers.delete(username);
        updateTypingDiv();
      });

      function updateTypingDiv() {
        if (typingUsers.size > 0) {
          typingDiv.style.display = "block";
          typingDiv.textContent =
            [...typingUsers].join(", ") +
            (typingUsers.size === 1 ? " is typing..." : " are typing...");
        } else {
          typingDiv.style.display = "none";
        }
      }
    </script>
  </body>
</html>
