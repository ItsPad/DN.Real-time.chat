<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Realtime Chat</title>
    <link rel="stylesheet" href="css/style.css" />
    <!-- à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰ -->
  </head>
  <body>
    <div class="chat-container">
      <header>
        <h2>REALTIME CHAT</h2>
        <div id="user-count" style="font-size: 0.9em; margin-top: 4px">
          Online: 0
        </div>
      </header>

      <ul id="messages"></ul>

      <div id="typing">User is typing...</div>
      <form action="" id="form">
        <input
          type="text"
          id="input"
          autocomplete="off"
          placeholder="Write some messages"
        />
        <button>Send</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const messages = document.getElementById("messages");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const userID = Date.now();
      const userCountDiv = document.getElementById("user-count");
      const typingDiv = document.getElementById("typing");
      typingDiv.style.display = "none"; // à¸‹à¹ˆà¸­à¸™à¸•à¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™

      let name = prompt("What is your desired username?");
      let typingUsers = new Set();

      // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit("username", name);
          socket.emit("chat message", {
            name: name,
            msg: input.value,
            user: userID,
          });
          input.value = "";
          socket.emit("stop typing", name); // à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡ name à¹„à¸›à¸”à¹‰à¸§à¸¢
        }
      });

      // ðŸ“Œ à¹à¸ˆà¹‰à¸‡ server à¸§à¹ˆà¸²à¸à¸³à¸¥à¸±à¸‡à¸žà¸´à¸¡à¸žà¹Œ
      input.addEventListener("input", () => {
        if (input.value.length > 0) {
          socket.emit("typing", name);
        } else {
          socket.emit("stop typing", name); // à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡ name à¹„à¸›à¸”à¹‰à¸§à¸¢
        }
      });

      // ðŸ“Œ à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸„à¸™à¸­à¸·à¹ˆà¸™
      socket.on("chat message", (msgObject) => {
        const message = document.createElement("li");
        const messageItem = document.createElement("span");
        messageItem.textContent = `${msgObject.name}: ${msgObject.msg}`;
        if (msgObject.user === userID) {
          message.classList.add("right");
        }
        message.appendChild(messageItem);
        messages.appendChild(message);
        messages.scrollTop = messages.scrollHeight; // auto scroll
      });

      // ðŸ“Œ à¸£à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™à¸„à¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ
      socket.on("user count", (count) => {
        userCountDiv.textContent = `ðŸŸ¢Online: ${count}`;
      });

      // ðŸ“Œ à¹à¸ªà¸”à¸‡à¸§à¹ˆà¸²à¹ƒà¸„à¸£à¸à¸³à¸¥à¸±à¸‡à¸žà¸´à¸¡à¸žà¹Œ
      socket.on("typing", (username) => {
        if (username !== name) {
          typingUsers.add(username);
          updateTypingDiv();
        }
      });

      // ðŸ“Œ à¸«à¸¢à¸¸à¸”à¹à¸ªà¸”à¸‡ typing
      socket.on("stop typing", (username) => {
        typingUsers.delete(username);
        updateTypingDiv();
      });

      function updateTypingDiv() {
        if (typingUsers.size > 0) {
          typingDiv.style.display = "block";
          typingDiv.textContent =
            [...typingUsers].join(", ") +
            (typingUsers.size === 1 ? " is typing..." : " are typing...");
        } else {
          typingDiv.style.display = "none";
        }
      }
    </script>
  </body>
</html>
